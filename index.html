<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COMET</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/awesomplete/awesomplete.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/awesomplete/awesomplete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  </head>

  <body>
    <!-- <h1 class="title">COMET</h1>
    <p class="subtitle">Your AI Terminal</p> -->
    <div class="window">
      <div class="bar">
        <div class="btn"></div>
      </div>
      <div class="body" style="height: 100vh">
        <pre class="art">
                                _____        
    ___________________ __________  /_       
    _  ___/  __ \_  __ `__ \  _ \  __/       
    / /__ / /_/ /  / / / / /  __/ /_         
    \___/ \____//_/ /_/ /_/\___/\__/         

    
</pre
        >
      </div>
    </div>
    <footer style="background: #191919">
      <div>
        <div class="footer-content">
          <div class="usage-info">
            <span id="memory-usage">Memory Usage:</span>
          </div>

          <canvas id="memory-chart" width="400" height="200"></canvas>

          <span id="cpu-usage">CPU Usage:</span>

          <canvas id="cpu-chart" width="400" height="200"></canvas>

          <span id="internet-speed-label">Internet Speed:</span>

          <canvas id="internet-speed-chart" width="400" height="200"></canvas>
        </div>
      </div>
    </footer>

    <script>
      const { ipcRenderer } = require("electron");

      let inputHistory = [];
      var inputIndex = 0;
      let lastErrorOutput = "";
      // Load Input History from JSON File
      function loadInputHistory() {
        ipcRenderer.send("load-input-history");
      }

      ipcRenderer.on("input-history-loaded", (event, data) => {
        console.log(data);
        inputHistory = data;
        const inputElement = document.querySelector(".input.command");
        new Awesomplete(inputElement, { list: inputHistory });
      });

      function saveInputHistory() {
        ipcRenderer.send("save-input-history", inputHistory);
      }

      function handleInput(event) {
        if (event.key === "Enter") {
          const inputText = event.target.value; // Get the input text
          inputHistory.push(inputText); // Save input in history
          saveInputHistory();
          ipcRenderer.send("run-command", inputText); // Send the input text to the main process
        }
      }

      window.onload = function () {
        loadInputHistory();

        appendInputContainer();
        // Listen for command output
        ipcRenderer.on("command-output", (event, output) => {
          appendOutput(output); // Use the existing function to append the output
          appendInputContainer();
        });
        ipcRenderer.on("command-error", (event, output) => {
          appendError(output); // Use the existing function to append the output
          appendInputContainer();
        });
        ipcRenderer.on("command-ai", (event, output) => {
          //console.log("\n this is explaination ->>>" + output.explaination);

          output.explaination = output.explaination.replace(/^"|"$/g, "");
          appendAi(output.explaination);
          // Use the existing function to append the output
          output.command = output.command.replace(/\\n|"/g, "");
          output.command = output.command.trim();
          console.log("\nthis is output ->>>" + output.command);
          console.log("\n this is explaination ->>>" + output.explaination);
          appendInputContainer(output.command);
        });
        ipcRenderer.on("command-error-ai", (event, output) => {
          console.log("this is the solution i found :", output);
          appendAiErrorSolution(output); // Use the existing function to append the output
          appendInputContainer();
        });
        ipcRenderer.on("command-help", (event, output) => {
          console.log("this is help :", output);
          appendHelp(output); // Use the existing function to append the output
          appendInputContainer();
        });
      };

      function handleInput(event) {
        if (event.key === "Enter") {
          const inputText = event.target.value; // Get the input text
          inputHistory.push(inputText); // Save input in history
          saveInputHistory();
          ipcRenderer.send("run-command", inputText); // Send the input text to the main process
        }
      }

      function appendOutput(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("output");
        outputDiv.textContent = text;
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.appendChild(outputDiv);
      }
      function appendError(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("error");
        outputDiv.textContent = text;
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.style.backgroundColor = "rgba(255, 0, 0, 0.1)";
        latestInputContainer.appendChild(outputDiv);
        lastErrorOutput = text;
      }
      function appendAi(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("ai");
        console.log(typeof text);
        const unescapedText = text
          .replace(/\\n/g, "\n")
          .replace(/\n\n\n/g, "\n")
          .replace(/\n\n/g, "\n")
          .replace(/\\n/g, "\n")
          .trim();
        console.log("this is final appenai output", unescapedText);
        outputDiv.innerHTML = marked.parse(unescapedText);
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.style.backgroundColor = "rgb(255,0,153,0.1)";
        latestInputContainer.appendChild(outputDiv);
      }
      function appendAiErrorSolution(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("ai-error-sol");

        const unescapedText = text
          .replace(/^"|"$/g, "")
          .replace(/\\n/g, "\n")
          .replace(/\n\n\n/g, "\n")
          .replace(/\n\n/g, "\n")
          .replace(/\\n/g, "\n")
          .trim();
        outputDiv.innerHTML = marked.parse(unescapedText);
        console.log("this is unescapedText", unescapedText);
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.style.backgroundColor = "rgb(3,180,163,0.1)";
        latestInputContainer.appendChild(outputDiv);
      }
      function appendHelp(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("help");
        const unescapedText = text
          .replace(/\n\n\n/g, "\n")
          .replace(/\n\n/g, "\n")
          .replace(/\\n/g, "\n")
          .trim();
        outputDiv.innerHTML = marked.parse(unescapedText);
        console.log("this is unescapedText", unescapedText);
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.style.backgroundColor = "rgb(145,253,68,0.1)";
        latestInputContainer.appendChild(outputDiv);
      }

      function appendInputContainer(defaultInput) {
        inputIndex++;
        loadInputHistory();
        //console.log(defaultInput);
        const terminalBody = document.querySelector(".body");
        const inputContainerDiv = document.createElement("div");
        inputContainerDiv.classList.add("input-container");
        inputContainerDiv.innerHTML = `
            <div class="prompt"><span class="input-arrow">$</span> <input type="text" id="input-${inputIndex}" class="input command" onkeydown="handleInput(event)" placeholder="Type your command..."></div>
            <div class="controls">
               <button class="control-button" onclick="clickAI()">
                  <img src="assets/icon-ai-white.png" class="btn-img-ai" alt="AI">
               </button>
               <button class="control-button" onclick="clickAIError()">
                  <img src="assets/icon-search-white.png" class="btn-img-err" alt="Error">
               </button>
               <button class="control-button" onclick="clickHelp()">
                  <img src="assets/icon-summary-white.png" class="btn-img-help" alt="Search">
               </button>
           </div>
      `;
        terminalBody.appendChild(inputContainerDiv);
        const newCommandInput = inputContainerDiv.querySelector(".command");
        if (defaultInput !== undefined) {
          newCommandInput.value = defaultInput;
        }
        newCommandInput.focus();
        const olderInputContainers2 = terminalBody.querySelectorAll(
          ".input-container:not(:last-child)"
        );
        olderInputContainers2.forEach((container) => {
          container.style.display = "block"; // Add the style display block
        });

        const olderInputContainers = terminalBody.querySelectorAll(
          ".input-container:not(:last-child) .controls"
        );
        olderInputContainers.forEach((container) => {
          container.style.visibility = "hidden";
          const inputs = container.parentElement.querySelectorAll(".input");
          inputs.forEach((input) => {
            input.disabled = true;
          });
        });
        // Remove controls from previous input, if any
        const previousInputContainer = terminalBody.querySelector(
          ".input-container:nth-last-child(2)"
        );
        if (previousInputContainer) {
          const previousInputControls =
            previousInputContainer.querySelector(".controls");
          previousInputControls.remove();
        }
        const inputElement = document.querySelector(`#input-${inputIndex}`);
        new Awesomplete(inputElement, { list: inputHistory });
        newCommandInput.focus();
      }

      function clickAI() {
        const inputText = document.querySelector(
          ".input-container:last-child .input.command"
        ).value;
        console.log("in Click ai", inputText);
        ipcRenderer.send("command-ai", inputText);
      }

      function clickAIError() {
        const inputText = inputHistory[inputHistory.length - 1]; // Get the last input command
        const outputText = lastErrorOutput;
        // Safely get the last error output
        console.log(
          "in Click AI Error, Input command : " +
            inputText +
            " Output command :" +
            outputText
        );
        ipcRenderer.send("command-error-ai", {
          input: inputText,
          output: outputText,
        });
      }

      function clickHelp() {
        const inputText = document.querySelector(
          ".input-container:last-child .input.command"
        ).value;
        console.log("in Click Help", inputText);
        ipcRenderer.send("command-help", inputText);
      }

      // Initialize Memory Chart
      // Initialize Memory Chart
      const memoryChartCtx = document
        .getElementById("memory-chart")
        .getContext("2d");
      const memoryChart = new Chart(memoryChartCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Memory Usage",
              data: [],
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
              fill: false,
              borderWidth: 1,
              pointRadius: 0,
            },
          ],
        },
        options: {
          scales: {
            x: {
              display: false,
            },
            y: {
              display: false,
            },
          },
          plugins: {
            decimation: {
              enabled: true,
              algorithm: "lttb",
              samples: 100,
              threshold: null,
            },
            legend: {
              display: false,
            },
          },
        },
      });

      const cpuChartCtx = document.getElementById("cpu-chart").getContext("2d");
      const cpuChart = new Chart(cpuChartCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "CPU Usage",
              data: [],
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
              fill: false,
              borderWidth: 1,
              pointRadius: 0,
            },
          ],
        },
        options: {
          scales: {
            x: {
              display: false,
            },
            y: {
              display: false,
            },
          },
          plugins: {
            decimation: {
              enabled: true,
              algorithm: "lttb",
              samples: 100,
              threshold: null,
            },
            legend: {
              display: false,
            },
          },
        },
      });

      const internetSpeedChartCtx = document
        .getElementById("internet-speed-chart")
        .getContext("2d");
      const internetSpeedChart = new Chart(internetSpeedChartCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Download Speed",
              data: [],
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
              fill: false,
              borderWidth: 1,
              pointRadius: 0,
            },
            {
              label: "Upload Speed",
              data: [],
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
              fill: false,
              borderWidth: 1,
              pointRadius: 0,
            },
          ],
        },
        options: {
          scales: {
            x: {
              display: false,
            },
            y: {
              display: false,
            },
          },
          plugins: {
            decimation: {
              enabled: true,
              algorithm: "lttb",
              samples: 100,
              threshold: null,
            },
            legend: {
              display: true,
            },
          },
        },
      });

      let previousMemoryUsage = 0;

      function updateMemoryUsage() {
        const memoryUsageElement = document.getElementById("memory-usage");
        const os = require("os");
        const totalRAM = os.totalmem();
        const freeRAM = os.freemem();
        const usedRAM = totalRAM - freeRAM;
        memoryUsageElement.textContent = `${(
          usedRAM /
          (1024 * 1024 * 1024)
        ).toFixed(2)} GB`;

        memoryChart.data.labels.push(new Date().toLocaleTimeString());
        memoryChart.data.datasets[0].data.push(usedRAM);
        memoryChart.update();
      }

      function updateCPUUsage() {
        const cpuUsageElement = document.getElementById("cpu-usage");
        const os = require("os");
        const cpuUsagePercentage = os.loadavg()[0] * 100;
        cpuUsageElement.textContent = `${cpuUsagePercentage.toFixed(2)} %`;

        cpuChart.data.labels.push(new Date().toLocaleTimeString());
        cpuChart.data.datasets[0].data.push(cpuUsagePercentage);
        cpuChart.update();
      }

      async function calculateInternetSpeed() {
        const speedTest = require("speedtest-net");
        try {
          const speed = await speedTest({ maxTime: 5000 });
          const downloadSpeed = speed.download.bandwidth / 1024 / 1024;
          const uploadSpeed = speed.upload.bandwidth / 1024 / 1024;
          console.log("this is download speeeeed :" + downloadSpeed);

          console.log("this is upload speeeeed :" + uploadSpeed);
          return { downloadSpeed, uploadSpeed };
        } catch (error) {
          console.error("Speed test failed:", error.message);
          return null;
        }
      }

      async function updateInternetSpeed() {
        try {
          const speed = await calculateInternetSpeed();
          console.log("Speed test result:", speed); // Log speed test result
          const timeNow = new Date().toLocaleTimeString();

          internetSpeedChart.data.labels.push(timeNow);
          internetSpeedChart.data.datasets[0].data.push(speed.downloadSpeed);
          internetSpeedChart.data.datasets[1].data.push(speed.uploadSpeed);

          const MAX_DATA_POINTS = 10;
          if (internetSpeedChart.data.labels.length > MAX_DATA_POINTS) {
            internetSpeedChart.data.labels.shift();
            internetSpeedChart.data.datasets.forEach((dataset) => {
              dataset.data.shift();
            });
          }

          internetSpeedChart.update();
        } catch (error) {
          console.error("Failed to update internet speed:", error.message);
        }
      }

      updateMemoryUsage();
      updateCPUUsage();
      updateInternetSpeed();
      setInterval(updateMemoryUsage, 500);
      setInterval(updateCPUUsage, 500);
      setInterval(updateInternetSpeed, 5000);
    </script>
  </body>
</html>
