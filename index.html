<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COMET</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/awesomplete/awesomplete.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/awesomplete/awesomplete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  </head>

  <body>
    <!-- <h1 class="title">COMET</h1>
    <p class="subtitle">Your AI Terminal</p> -->
    <div class="window">
      <div class="bar">
        <div class="btn"></div>
      </div>
      <div class="body" style="height: 100vh">
        <pre class="art">
                                _____        
    ___________________ __________  /_       
    _  ___/  __ \_  __ `__ \  _ \  __/       
    / /__ / /_/ /  / / / / /  __/ /_         
    \___/ \____//_/ /_/ /_/\___/\__/         

    
</pre
        >
      </div>
    </div>
    <footer style="background: #191919">
      <footer style="background: #191919">
        <div class="footer-content" style="height: 80px; width: 100%">
          <div class="usage-info">
            <span
              id="memory-usage"
              style="color: white; margin-left: 5px; margin-right: 10px"
              >Memory Usage:
            </span>
          </div>

          <canvas id="memory-chart"></canvas>

          <span
            id="ram-usage"
            style="color: white; margin-left: 5px; margin-right: 10px"
            >RAM Usage:
          </span>

          <canvas id="ram-chart"></canvas>

          <span
            id="memory-change"
            style="color: white; margin-left: 5px; margin-right: 10px"
            >Memory Change:
          </span>

          <canvas id="memory-change-chart"></canvas>
        </div>
      </footer>
    </footer>

    <script>
      const { ipcRenderer } = require("electron");

      let inputHistory = [];
      var inputIndex = 0;
      let lastErrorOutput = "";
      // Load Input History from JSON File
      function loadInputHistory() {
        ipcRenderer.send("load-input-history");
      }

      ipcRenderer.on("input-history-loaded", (event, data) => {
        console.log(data);
        inputHistory = data;
        const inputElement = document.querySelector(".input.command");
        new Awesomplete(inputElement, { list: inputHistory });
      });

      function saveInputHistory() {
        ipcRenderer.send("save-input-history", inputHistory);
      }

      function handleInput(event) {
        if (event.key === "Enter") {
          const inputText = event.target.value; // Get the input text
          inputHistory.push(inputText); // Save input in history
          saveInputHistory();
          ipcRenderer.send("run-command", inputText); // Send the input text to the main process
        }
      }

      window.onload = function () {
        loadInputHistory();

        appendInputContainer();
        // Listen for command output
        ipcRenderer.on("command-output", (event, output) => {
          appendOutput(output); // Use the existing function to append the output
          appendInputContainer();
        });
        ipcRenderer.on("command-error", (event, output) => {
          appendError(output); // Use the existing function to append the output
          appendInputContainer();
        });
        ipcRenderer.on("command-ai", (event, output) => {
          //console.log("\n this is explaination ->>>" + output.explaination);

          output.explaination = output.explaination.replace(/^"|"$/g, "");
          appendAi(output.explaination);
          // Use the existing function to append the output
          output.command = output.command.replace(/\\n|"/g, "");
          output.command = output.command.trim();
          console.log("\nthis is output ->>>" + output.command);
          console.log("\n this is explaination ->>>" + output.explaination);
          appendInputContainer(output.command);
        });
        ipcRenderer.on("command-error-ai", (event, output) => {
          console.log("this is the solution i found :", output);
          appendAiErrorSolution(output); // Use the existing function to append the output
          appendInputContainer();
        });
        ipcRenderer.on("command-help", (event, output) => {
          console.log("this is help :", output);
          appendHelp(output); // Use the existing function to append the output
          appendInputContainer();
        });
      };

      function handleInput(event) {
        if (event.key === "Enter") {
          const inputText = event.target.value; // Get the input text
          inputHistory.push(inputText); // Save input in history
          saveInputHistory();
          ipcRenderer.send("run-command", inputText); // Send the input text to the main process
        }
      }

      function appendOutput(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("output");
        outputDiv.textContent = text;
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.appendChild(outputDiv);
      }
      function appendError(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("error");
        outputDiv.textContent = text;
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.style.backgroundColor = "rgba(255, 0, 0, 0.1)";
        latestInputContainer.appendChild(outputDiv);
        lastErrorOutput = text;
      }
      function appendAi(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("ai");
        console.log(typeof text);
        const unescapedText = text
          .replace(/\\n/g, "\n")
          .replace(/\n\n\n/g, "\n")
          .replace(/\n\n/g, "\n")
          .replace(/\\n/g, "\n")
          .trim();
        console.log("this is final appenai output", unescapedText);
        outputDiv.innerHTML = marked.parse(unescapedText);
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.style.backgroundColor = "rgb(255,0,153,0.1)";
        latestInputContainer.appendChild(outputDiv);
      }
      function appendAiErrorSolution(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("ai-error-sol");

        const unescapedText = text
          .replace(/^"|"$/g, "")
          .replace(/\\n/g, "\n")
          .replace(/\n\n\n/g, "\n")
          .replace(/\n\n/g, "\n")
          .replace(/\\n/g, "\n")
          .trim();
        outputDiv.innerHTML = marked.parse(unescapedText);
        console.log("this is unescapedText", unescapedText);
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.style.backgroundColor = "rgb(3,180,163,0.1)";
        latestInputContainer.appendChild(outputDiv);
      }
      function appendHelp(text) {
        const terminalBody = document.querySelector(".body");
        const outputDiv = document.createElement("div");
        outputDiv.classList.add("help");
        const unescapedText = text
          .replace(/\n\n\n/g, "\n")
          .replace(/\n\n/g, "\n")
          .replace(/\\n/g, "\n")
          .trim();
        outputDiv.innerHTML = marked.parse(unescapedText);
        console.log("this is unescapedText", unescapedText);
        const latestInputContainer = terminalBody.querySelector(
          ".input-container:last-child"
        );
        latestInputContainer.style.backgroundColor = "rgb(145,253,68,0.1)";
        latestInputContainer.appendChild(outputDiv);
      }

      function appendInputContainer(defaultInput) {
        inputIndex++;
        loadInputHistory();
        //console.log(defaultInput);
        const terminalBody = document.querySelector(".body");
        const inputContainerDiv = document.createElement("div");
        inputContainerDiv.classList.add("input-container");
        inputContainerDiv.innerHTML = `
            <div class="prompt"><span class="input-arrow">$</span> <input type="text" id="input-${inputIndex}" class="input command" onkeydown="handleInput(event)" placeholder="Type your command..."></div>
            <div class="controls">
               <button class="control-button" onclick="clickAI()">
                  <img src="assets/icon-ai-white.png" class="btn-img-ai" alt="AI">
               </button>
               <button class="control-button" onclick="clickAIError()">
                  <img src="assets/icon-search-white.png" class="btn-img-err" alt="Error">
               </button>
               <button class="control-button" onclick="clickHelp()">
                  <img src="assets/icon-summary-white.png" class="btn-img-help" alt="Search">
               </button>
           </div>
      `;
        terminalBody.appendChild(inputContainerDiv);
        const newCommandInput = inputContainerDiv.querySelector(".command");
        if (defaultInput !== undefined) {
          newCommandInput.value = defaultInput;
        }
        newCommandInput.focus();
        const olderInputContainers2 = terminalBody.querySelectorAll(
          ".input-container:not(:last-child)"
        );
        olderInputContainers2.forEach((container) => {
          container.style.display = "block"; // Add the style display block
        });

        const olderInputContainers = terminalBody.querySelectorAll(
          ".input-container:not(:last-child) .controls"
        );
        olderInputContainers.forEach((container) => {
          container.style.visibility = "hidden";
          const inputs = container.parentElement.querySelectorAll(".input");
          inputs.forEach((input) => {
            input.disabled = true;
          });
        });
        // Remove controls from previous input, if any
        const previousInputContainer = terminalBody.querySelector(
          ".input-container:nth-last-child(2)"
        );
        if (previousInputContainer) {
          const previousInputControls =
            previousInputContainer.querySelector(".controls");
          previousInputControls.remove();
        }
        const inputElement = document.querySelector(`#input-${inputIndex}`);
        new Awesomplete(inputElement, { list: inputHistory });
        newCommandInput.focus();
      }

      function clickAI() {
        const inputText = document.querySelector(
          ".input-container:last-child .input.command"
        ).value;
        console.log("in Click ai", inputText);
        ipcRenderer.send("command-ai", inputText);
      }

      function clickAIError() {
        const inputText = inputHistory[inputHistory.length - 1]; // Get the last input command
        const outputText = lastErrorOutput;
        // Safely get the last error output
        console.log(
          "in Click AI Error, Input command : " +
            inputText +
            " Output command :" +
            outputText
        );
        ipcRenderer.send("command-error-ai", {
          input: inputText,
          output: outputText,
        });
      }

      function clickHelp() {
        const inputText = document.querySelector(
          ".input-container:last-child .input.command"
        ).value;
        console.log("in Click Help", inputText);
        ipcRenderer.send("command-help", inputText);
      }

      // Initialize Memory Chart
      // Initialize Memory Chart
      const memoryChartCtx = document
        .getElementById("memory-chart")
        .getContext("2d");
      const memoryChart = new Chart(memoryChartCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Memory Usage",
              data: [],
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
              fill: false,
              borderCapStyle: "butt",
              borderWidth: 1,
              pointRadius: 0,
              borderJoinStyle: "miter",
            },
          ],
        },
        options: {
          scales: {
            x: {
              display: false,
            },
            y: {
              display: false,
            },
          },
          plugins: {
            decimation: {
              enabled: true,
              algorithm: "lttb",
              samples: 100, // Increase the number of samples
              threshold: null,
            },
            legend: {
              display: false,
            },
          },
        },
      });

      // Initialize RAM Chart
      const ramChartCtx = document.getElementById("ram-chart").getContext("2d");
      const ramChart = new Chart(ramChartCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "RAM Usage",
              data: [],
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
              fill: false,
              borderCapStyle: "butt",
              borderWidth: 1,
              pointRadius: 0,
              borderJoinStyle: "miter",
            },
          ],
        },
        options: {
          scales: {
            x: {
              display: false,
            },
            y: {
              display: false,
            },
          },
          plugins: {
            decimation: {
              enabled: true,
              algorithm: "lttb",
              samples: 100, // Increase the number of samples
              threshold: null,
            },
            legend: {
              display: false,
            },
          },
        },
      });

      // Initialize Memory Change Chart
      const memoryChangeChartCtx = document
        .getElementById("memory-change-chart")
        .getContext("2d");
      const memoryChangeChart = new Chart(memoryChangeChartCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Memory Change",
              data: [],
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
              fill: false,
              borderCapStyle: "butt",
              borderWidth: 1,
              pointRadius: 0,
              borderJoinStyle: "miter",
              spanGaps: true,
            },
          ],
        },
        options: {
          scales: {
            x: {
              display: false,
            },
            y: {
              display: false,
            },
          },
          plugins: {
            decimation: {
              enabled: true,
              algorithm: "lttb",
              samples: 100, // Increase the number of samples
              threshold: null,
            },
            legend: {
              display: false,
            },
          },
        },
      });

      // Global variable to store previous memory usage
      let previousMemoryUsage = 0;

      // Function to update Memory Usage
      function updateMemoryUsage() {
        const memoryUsageElement = document.getElementById("memory-usage");
        const os = require("os");
        const totalRAM = os.totalmem();
        const freeRAM = os.freemem();
        const usedRAM = totalRAM - freeRAM;
        memoryUsageElement.textContent = `${(
          usedRAM /
          (1024 * 1024 * 1024)
        ).toFixed(2)} GB`;

        // Add new data point to Memory Chart
        memoryChart.data.labels.push(new Date().toLocaleTimeString());
        memoryChart.data.datasets[0].data.push(usedRAM); // Convert to MB
        memoryChart.update();
      }

      // Function to update RAM Usage
      function updateRAMUsage() {
        const ramUsageElement = document.getElementById("ram-usage");
        const os = require("os");
        const totalRAM = os.totalmem();
        const freeRAM = os.freemem();
        const usedRAM = totalRAM - freeRAM;
        const ramUsagePercentage = ((usedRAM / totalRAM) * 100).toFixed(2);
        ramUsageElement.textContent = `${ramUsagePercentage} %`;

        // Add new data point to RAM Chart
        ramChart.data.labels.push(new Date().toLocaleTimeString());
        ramChart.data.datasets[0].data.push(ramUsagePercentage);
        ramChart.update();
      }

      // Function to update Memory Change
      function updateMemoryChange() {
        const memoryChangeElement = document.getElementById("memory-change");
        const currentMemoryUsage = process.memoryUsage().rss;
        const memoryChange = currentMemoryUsage - previousMemoryUsage;
        const changeText =
          memoryChange >= 0
            ? `${(memoryChange / 1024).toFixed(1)} kb increasing`
            : `${(-memoryChange / 1024).toFixed(1)} kb decreasing`;
        memoryChangeElement.textContent = changeText;

        // Add new data point to Memory Change Chart
        const timeNow = new Date().toLocaleTimeString();
        memoryChangeChart.data.labels.push(timeNow);
        memoryChangeChart.data.datasets[0].data.push(memoryChange / 1024); // Convert to KB

        // Limit the number of data points to display for better performance
        const MAX_DATA_POINTS = 10;
        if (memoryChangeChart.data.labels.length > MAX_DATA_POINTS) {
          memoryChangeChart.data.labels.shift(); // Remove the oldest label
          memoryChangeChart.data.datasets[0].data.shift(); // Remove the oldest data point
        }

        // Update the chart
        memoryChangeChart.update();

        // Update previous memory usage
        previousMemoryUsage = currentMemoryUsage;
      }

      // Update charts initially and then periodically
      updateMemoryUsage();
      updateRAMUsage();
      updateMemoryChange();
      setInterval(updateMemoryUsage, 500);
      setInterval(updateRAMUsage, 500);
      setInterval(updateMemoryChange, 500);

      // const ctx = document.getElementById("performance-chart").getContext("2d");
      // const performanceChart = new Chart(ctx, {
      //   type: "line",
      //   data: {
      //     labels: [],
      //     datasets: [
      //       {
      //         label: "Memory Usage",
      //         data: [],
      //         borderColor: "rgb(75, 192, 192)",
      //         tension: 0.1,
      //         fill: false,
      //       },
      //       {
      //         label: "RAM Usage",
      //         data: [],
      //         borderColor: "rgb(255, 99, 132)",
      //         tension: 0.1,
      //         fill: false,
      //       },
      //       {
      //         label: "Memory Change",
      //         data: [],
      //         borderColor: "rgb(75, 192, 192)",
      //         tension: 0.1,
      //         fill: false,
      //         borderCapStyle: butt,
      //       },
      //     ],
      //   },
      //   options: {
      //     scales: {
      //       y: {
      //         beginAtZero: true,
      //       },
      //     },
      //     plugins: {
      //       decimation: {
      //         // Configure the Data Decimation plugin
      //         enabled: true,
      //         algorithm: "lttb", // Choose the decimation algorithm ('lttb' or 'min-max')
      //         samples: null, // Number of samples in the output dataset (defaults to canvas width)
      //         threshold: null, // Threshold value for triggering decimation (defaults to 4 times canvas width)
      //       },
      //     },
      //   },
      // });

      // // Function to update Memory Usage
      // function updateMemoryUsage1() {
      //   // Your memory usage update logic here
      //   const memoryUsage = Math.random() * 100; // Example data, replace with actual logic
      //   performanceChart.data.datasets[0].data.push(memoryUsage);
      //   performanceChart.data.labels.push(new Date().toLocaleTimeString());
      //   performanceChart.update();
      // }

      // // Function to update RAM Usage
      // function updateRAMUsage1() {
      //   // Your RAM usage update logic here
      //   const ramUsage = Math.random() * 100; // Example data, replace with actual logic
      //   performanceChart.data.datasets[1].data.push(ramUsage);
      //   performanceChart.update();
      // }

      // // Function to update Memory Change
      // function updateMemoryChange1() {
      //   // Your memory change update logic here
      //   const memoryChange = Math.random() * 20 - 10; // Example data, replace with actual logic
      //   performanceChart.data.datasets[2].data.push(memoryChange);
      //   performanceChart.update();
      // }

      // // Update charts initially and then periodically
      // updateMemoryUsage1();
      // updateRAMUsage1();
      // updateMemoryChange1();
      // setInterval(updateMemoryUsage1, 1000);
      // setInterval(updateRAMUsage1, 1000);
      // setInterval(updateMemoryChange1, 1000);
    </script>
  </body>
</html>
